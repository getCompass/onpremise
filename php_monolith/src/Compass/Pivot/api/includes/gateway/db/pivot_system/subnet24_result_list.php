<?php

namespace Compass\Pivot;

/**
 * модель для таблицы
 * сгенерирована автоматически
 * Type_CodeGen_DbGateway::do("pivot_system", "subnet_24_result_list");
 */
class Gateway_Db_PivotSystem_Subnet24ResultList extends Gateway_Db_PivotSystem_Main {

	/** @var string имя таблицы */
	public const TABLE_KEY = "subnet_24_result_list";

	// -------------------------------------------------------
	// AUTOGENERATED FUNCTIONS
	// -------------------------------------------------------

	// вставляем запись
	public static function insert(
		int    $subnet_24,
		int    $is_mobile,
		int    $is_proxy,
		int    $is_hosting,
		string $country_code,
		string $as
	):int {

		$insert = [
			"subnet_24"    => $subnet_24,
			"is_mobile"    => $is_mobile,
			"is_proxy"     => $is_proxy,
			"is_hosting"   => $is_hosting,
			"country_code" => $country_code,
			"as"           => $as,
			"created_at"   => time(),
		];
		return ShardingGateway::database(self::_getDbKey())->insert(self::TABLE_KEY, $insert);
	}

	// получаем запись
	public static function get(int $subnet_24):Struct_Db_PivotSystem_Subnet24ResultList {

		// запрос проверен на EXPLAIN (INDEX=`PRIMARY`)
		$query = "SELECT * FROM `?p` WHERE `subnet_24`=?i LIMIT ?i";
		$row   = ShardingGateway::database(self::_getDbKey())->getOne($query, self::TABLE_KEY, $subnet_24, 1);
		return self::_formatRow($row);
	}

	// проверяем существует ли запись
	public static function isExist(int $subnet_24):bool {

		try {
			self::get($subnet_24);
			return true;
		} catch (\cs_RowIsEmpty) {
			return false;
		}
	}

	// обновляем запись
	public static function update(int $subnet_24, array $set):int {


		$set["updated_at"] = time();

		// запрос проверен на EXPLAIN (INDEX=`PRIMARY`)
		$query = "UPDATE `?p` SET ?u WHERE `subnet_24`=?i LIMIT ?i";
		return ShardingGateway::database(self::_getDbKey())->update($query, self::TABLE_KEY, $set, $subnet_24, 1);
	}

	// получаем записи по массиву из первичных ключей
	public static function getListByIn(array $in):array {

		if (sizeof($in) == 0) {
			return [];
		}

		// запрос проверен на EXPLAIN (INDEX=`PRIMARY`)
		$query = "SELECT * FROM `?p` WHERE `subnet_24` IN (?a) LIMIT ?i";
		$list  = ShardingGateway::database(self::_getDbKey())->getAll($query, self::TABLE_KEY, $in, sizeof($in));
		return self::_formatList($list);
	}

	// -------------------------------------------------------
	// CUSTOM FUNCTIONS
	// -------------------------------------------------------

	// -------------------------------------------------------
	// PROTECTED
	// -------------------------------------------------------

	/**
	 * форматируем список записей из базы
	 *
	 * @return Struct_Db_PivotSystem_Subnet24ResultList[]
	 */
	protected static function _formatList(array $list):array {

		return array_map([self::class, "_formatRow"], $list);
	}

	// форматируем одну запись из базы
	protected static function _formatRow(array $row):Struct_Db_PivotSystem_Subnet24ResultList {

		if (empty($row)) {
			throw new \cs_RowIsEmpty();
		}
		return Struct_Db_PivotSystem_Subnet24ResultList::rowToStruct($row);
	}
}